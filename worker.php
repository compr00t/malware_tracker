<?php
	error_reporting( E_ERROR );

	# check if ip is responding
	function availableUrl($host, $port=80, $timeout=1) { 
		$fp = fSockOpen($host, $port, $errno, $errstr, $timeout);
		if ($fp != false) { return "Online"; } else { return "Offline"; }
	}

	# check SBL entry
	function sblCheck($host) {
		$rbl  = 'sbl.spamhaus.org';
		$rev = array_reverse(explode('.', $host));
		$lookup = implode('.', $rev) . '.' . $rbl;

		if ($lookup != gethostbyname($lookup)) {
    			return sblGet($host);
		} else {
    			return "not listed";
		}
	}

	# get SBL Number
	function sblGet($host) {
		$content = file_get_contents("https://www.spamhaus.org/query/ip/".$host);
		preg_match("/SBL[0-9]{4,8}/", $content, $out);
		foreach ($out as $val) { if ($val != "") { 
			return "<a href=\"https://www.spamhaus.org/sbl/query/".$val."\" target=\"_blank\">".$val."</a>"; 
		} }
	}

	# get AS number
	function getASN($host) {
		$asn_raw = geoip_asnum_by_name($host);
		preg_match("/AS[0-9]+/", $asn_raw, $out);
		foreach ($out as $val) { if ($val != "") { 
			return "<a href=\"http://viewdns.info/asnlookup/?asn=".substr($val, 2)."\" target=\"_blank\">".$val."</a>";
		} }	
	}

	# get AS name
	function getResp($host) {
                $asn_raw = geoip_asnum_by_name($host);
		preg_match("/\s.*/", $asn_raw, $out);
		foreach ($out as $val) { return substr($val, 1); }
        }

	# split input (date; ip)
	function doSplit($raw) {
		$string = preg_replace( "/\r|\n/", "", $raw );
		$out = explode(";", $string);
		return $out;
	}

	# create XML tree
	$domtree = new DOMDocument('1.0', 'UTF-8');
	$xmlRoot = $domtree->createElement("xml");
	$xmlRoot = $domtree->appendChild($xmlRoot);
	$malware = $domtree->createElement("malware");
	$malware = $xmlRoot->appendChild($malware);

	$count = 1;

	# read entries from file
	$file = fopen("ips.txt", "r");
	while(!feof($file)){
    		$line = fgets($file);

		if ($line != null) {

			$out = doSplit($line);
			$ip = $out[1];

			$entry = $domtree->createElement("obj");
			$entry = $malware->appendChild($entry);

			# write informations into the tree
			$entry->appendChild($domtree->createElement('date',$out[0]));
			$entry->appendChild($domtree->createElement('ip',$ip));
			$entry->appendChild($domtree->createElement('domain',gethostbyaddr($ip)));
			$entry->appendChild($domtree->createElement('status',availableUrl($ip)));
			$entry->appendChild($domtree->createElement('sbl',sblCheck($ip)));
			$entry->appendChild($domtree->createElement('asn',getASN($ip)));
			$entry->appendChild($domtree->createElement('responsible',getResp($ip)));
			$entry->appendChild($domtree->createElement('country',geoip_country_code_by_name($ip)));
		}
	}

	# save XML and close file
	$domtree->save('data.xml');
	fclose($file);
?>
